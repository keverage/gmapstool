!function(t){"use strict";t.GmapsTool=function(e,s){return this.elements={container:e},t.extend(!0,this.settings={},t.GmapsTool.defaults,s),this.gmap,this.markers=[],this.markersOptions={},this.infoWindow,this.layers=[],this.pathAPI="https://maps.googleapis.com/maps/api",this.style=!1,this},t.GmapsTool.defaults={map:{center:void 0,zoom:10,minZoom:7,maxZoom:17},apiKey:void 0,fullscreen:!1,type:"js",staticOptions:{size:"300x300",scale:2,maptype:"roadmap"},richMarkerOptions:{draggable:!1,shadow:"none"},cluster:!1,clusterOptions:{svg:{color:"#303748",colors:[],sizes:[36,46,56,66,76],textColor:"#fff",borderWidth:1,borderColor:"#fff"}},infoWindowOptions:{pixelOffset:[0,-30]}},t.GmapsTool.prototype={prepareOptions:function(){return 0===this.elements.container.length?(this.setLog("error","Selector not found"),!1):void 0===this.settings.map.center?(this.setLog("error","Missing center parameter"),!1):(this.settings.map.center=this.getLatLng(this.settings.map.center),this.settings.fullscreen&&(this.settings.map.scrollwheel=!1),"staticmap"===this.settings.type&&void 0===this.settings.staticOptions.apiKey&&this.setLog("error",'Missing "apiKey" parameter'),!0)},init:function(){return this.prepareOptions()&&("staticmap"===this.settings.type?!1===this.style&&this.initStatic():this.gmap=new google.maps.Map(this.elements.container[0],this.settings.map)),this},setStatic:function(e){return this.settings.type="staticmap",t.extend(!0,this.settings.staticOptions,e),this},initStatic:function(){var e=this,s={};t.extend(!0,s,e.settings.map,e.settings.staticOptions),s.key=e.settings.apiKey,delete s.minZoom,delete s.maxZoom;var n=e.pathAPI+"/"+e.settings.type+"?",o=0;t.each(s,function(t,e){o>0&&(n+="&"),n+=t+"="+e,o++});var i=e.settings.staticOptions.size.split("x");return t("<img>",{src:n,width:i[0],height:i[1],alt:""}).appendTo(e.elements.container),e},setOptions:function(e){return t.extend(!0,this.settings,e),this},setMapOptions:function(t){return this.getMap().setOptions(t),this},setMarkers:function(e,s){var n=this;return"staticmap"===n.settings.type&&e.length?(n.settings.staticOptions.markers="",t.each(e,function(t,e){"string"!=typeof e.content||"string"==typeof e.content&&-1===e.content.indexOf("http")?n.setLog("error","Marker content must be online and must be an PNG image."):n.settings.staticOptions.markers+="icon:"+encodeURIComponent(e.content)+"|"+e.position.join(",")})):(n.bounds=new google.maps.LatLngBounds,n.markersOptions=s,void 0===n.markersOptions.centerBounds&&(n.markersOptions.centerBounds=!0),n.prepareMarkersOptions(e)&&(e.length&&t.each(e,function(t,e){n.setMarker(e)}),n.markersOptions.centerBounds&&n.setCenter(),void 0!==n.markersOptions.cluster&&!0===n.markersOptions.cluster&&n.addMarkersClusters(),void 0!==n.markersOptions.onComplete&&n.markersOptions.onComplete.call({GmapsTool:n,markers:n.getMarkers(),bounds:n.bounds}))),n},prepareMarkersOptions:function(e){if(void 0===e)return this.setLog("error","Missing markers parameter"),!1;if("undefined"==typeof RichMarker)return this.setLog("error",'Missing "RichMarker" dependency'),!1;var s=!1;return t.each(e,function(t,e){e.hasOwnProperty("infoWindow")&&(s=!0)}),s&&(void 0!==this.markersOptions.infoWindowOptions&&t.extend(this.settings.infoWindowOptions,this.markersOptions.infoWindowOptions),this.settings.infoWindowOptions.pixelOffset=new google.maps.Size(this.settings.infoWindowOptions.pixelOffset[0],this.settings.infoWindowOptions.pixelOffset[1]),this.infoWindow=new google.maps.InfoWindow(this.settings.infoWindowOptions)),!0},getMarkers:function(){return this.markers},addMarkersClusters:function(){var e=this;if("undefined"==typeof MarkerClusterer)return e.setLog("error",'Missing "MarkerClusterer" dependency'),!1;var s={maxZoom:e.settings.map.maxZoom-1};!1!==e.settings.clusterOptions.svg&&Object.keys(e.settings.clusterOptions.svg).length&&Object.keys(e.settings.clusterOptions.svg.sizes).length&&(s.styles=[],t.each(e.settings.clusterOptions.svg.sizes,function(t,n){var o=e.settings.clusterOptions.svg.colors.length?e.settings.clusterOptions.svg.colors[t]:e.settings.clusterOptions.svg.color,i='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="25" stroke="'+e.settings.clusterOptions.svg.borderColor+'" stroke-width="'+e.settings.clusterOptions.svg.borderWidth+'" fill="'+o+'" /></svg>';s.styles.push({textColor:e.settings.clusterOptions.svg.textColor,url:"data:image/svg+xml;base64,"+window.btoa(i),width:n,height:n})})),t.extend(!0,e.settings.clusterOptions,s,e.markersOptions.clusterOptions);var n=[];return t.each(e.getMarkers(),function(t,e){n.push(e.richMarker)}),new MarkerClusterer(e.getMap(),n,e.settings.clusterOptions)},setMarker:function(e){var s=this;e.position=s.getLatLng(e.position),t.extend(!0,e.richMarkerOptions={},s.settings.richMarkerOptions,{map:s.getMap(),content:"object"==typeof e.content?e.content[0]:e.content,position:e.position}),e.richMarker=new RichMarker(e.richMarkerOptions),e.hasOwnProperty("infoWindow")&&!s.markersOptions.hasOwnProperty("onClick")&&(s.markersOptions.onClick=function(){s.openInfoWindow(this)});return t.each(["click","dblclick","mouseover","mouseout"],function(t,n){var o=s.formatEventName(n);void 0!==s.markersOptions[o]&&google.maps.event.addListener(e.richMarker,n,function(){s.markersOptions[o].call({GmapsTool:s,marker:e,event:this})})}),s.bounds.extend(e.position),s.markers.push(e),void 0!==s.markersOptions.onAdd&&s.markersOptions.onAdd.call({GmapsTool:s,marker:e}),e},openInfoWindow:function(t){var e=t.GmapsTool||this;return e.closeInfoWindow(),t.marker.infoWindow.length&&(e.getInfoWindow().setContent("object"==typeof t.marker.infoWindow?t.marker.infoWindow[0].outerHTML:t.marker.infoWindow),e.getInfoWindow().setPosition(t.marker.position),e.getInfoWindow().open(e.getMap()),e.getInfoWindow().GmapsTool=e,t.marker.content.addClass("is-open"),google.maps.event.addListener(e.getInfoWindow(),"closeclick",e.closeInfoWindow),void 0!==e.markersOptions.onInfoWindowOpen&&e.markersOptions.onInfoWindowOpen.call({GmapsTool:e,event:t.event,marker:t.marker,infoWindow:e.getInfoWindow()})),e},closeInfoWindow:function(){var e=this.GmapsTool||this;return e.markers.length&&t.each(e.markers,function(){this.content.removeClass("is-open")}),void 0!==e.markersOptions.onInfoWindowClose&&e.markersOptions.onInfoWindowClose.call({GmapsTool:e,infoWindow:e.getInfoWindow()}),e},getInfoWindow:function(){return this.infoWindow},setCenter:function(){return void 0!==this.bounds?(this.getMarkers().length>1&&this.getMap().fitBounds(this.bounds),this.getMap().setCenter(this.bounds.getCenter())):this.getMap().setCenter(this.settings.map.center),this},setLayers:function(e,s){var n=this;return n.layers=[],void 0===s&&(s={}),void 0!==e&&e.length>0&&t.each(e,function(t,e){n.prepareLayerOptions(e)&&n.setLayer(e,s)}),void 0!==s.onComplete&&s.onComplete.call({GmapsTool:n,layers:n.getLayers()}),n},getLayers:function(){return this.layers},prepareLayerOptions:function(t){return void 0===t.path||"http"===t.path.substring(0,4)||(this.setLog("error","The "+t.type+" file must be online"),!1)},setLayer:function(e,s){var n=this;t.extend(s,{url:e.path,preserveViewport:!0,map:n.getMap()}),e.layer=new google.maps.KmlLayer(s);return t.each(["click","defaultviewport_changed","status_changed"],function(t,o){var i=n.formatEventName(o);void 0!==s[i]&&e.layer.addListener(o,function(){s[i].call({GmapsTool:n,layer:e,event:this})})}),n.layers.push(e),void 0!==s.onAdd&&s.onAdd.call({GmapsTool:n,layer:e}),e},setStyles:function(e){var s=this;return s.style=!0,t.getJSON(e).fail(function(){s.setLog("error","Json file not found")}).done(function(t){"staticmap"===s.settings.type?(s.settings.staticOptions.style=s.staticFormatStyles(t),s.initStatic()):s.getMap().set("styles",t)}),s},staticFormatStyles:function(t){var e=[],s=0;for(e.length=0,s;s<t.length;s++){var n=t[s],o=n.hasOwnProperty("featureType"),i=n.hasOwnProperty("elementType"),r=n.stylers,a="",p="";o||i?(o&&(a="feature:"+n.featureType),i&&(a=a?a+"|":"",a+="element:"+n.elementType)):a="feature:all";var l=0;for(l;l<r.length;l++){var c=r[l],g=Object.keys(c)[0];p=p?p+"|":"",p+=g+":"+(function(t){return/^#[0-9a-f]{6}$/i.test(t.toString())}(c[g])?function(t){return"0x"+t.slice(1)}(c[g]):c[g])}e.push(a+"|"+p)}return e.join("&style=")},setControls:function(e){var s=this;void 0===e&&(e={});var n={};if(t.extend(n,{mapTypeControl:!1,streetViewControl:!1,zoomControl:!1},e.mapOptions),this.setMapOptions(n),void 0!==e.zoom){t.each(["in","out"],function(t,n){void 0!==e.zoom[n]&&e.zoom[n].length&&google.maps.event.addDomListener(e.zoom[n][0],"click",function(t){var o=s.getMap().getZoom();s.getMap().setZoom("in"===n?++o:--o),void 0!==e.zoom.onClick&&e.zoom.onClick.call({GmapsTool:s,zoom:{type:n,level:o},event:t})})})}return s},setLog:function(t,e){console[t]("GmapsTool: "+e)},getLatLng:function(t){return"string"==typeof t&&-1!==t.indexOf(",")&&(t=t.split(",")),"object"==typeof t&&2===t.length&&("staticmap"===this.settings.type?t[0]+","+t[1]:new google.maps.LatLng(t[0],t[1]))},getMap:function(){return this.gmap},formatEventName:function(t){return"on"+t.substr(0,1).toUpperCase()+t.substr(1)}},t.fn.gmapsTool=function(e){return new t.GmapsTool(t(this),e)}}(jQuery);