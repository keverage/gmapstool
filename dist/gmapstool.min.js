!function(e){"use strict";e.GmapsTool=function(t,s,o){return this.elements={gmapId:t},e.extend(this.gmapOptions={},e.GmapsTool.defaults.gmapOptions,s),e.extend(this.settings={},e.GmapsTool.defaults,o),delete this.settings.gmapOptions,this.markers=[],this.layers=[],this},e.GmapsTool.defaults={gmapOptions:{center:void 0,zoom:10,minZoom:7,maxZoom:17},fullscreen:!1,richMarkerOptions:{draggable:!1,shadow:"none"},cluster:!1,clusterOptions:{svg:{color:"#303748",colors:[],sizes:[36,46,56,66,76],textColor:"#fff",borderWidth:1,borderColor:"#fff"}}},e.GmapsTool.prototype={prepareOptions:function(){return 0===this.elements.gmapId.length?(this.setLog("error","Selector not found"),!1):void 0===this.gmapOptions.center?(this.setLog("error","Missing center parameter"),!1):(this.gmapOptions.center=this.getLatLng(this.gmapOptions.center),this.settings.fullscreen&&(this.gmapOptions.scrollwheel=!1),!0)},init:function(){return this.prepareOptions()&&(this.gmap=new google.maps.Map(this.elements.gmapId[0],this.gmapOptions)),this},setMapOptions:function(e){return this.gmap.setOptions(e),this},setMarkers:function(t,s){var o=this;return o.bounds=new google.maps.LatLngBounds,void 0===(s=s||{}).centerBounds&&(s.centerBounds=!0),o.prepareMarkersOptions(t)&&(t.length&&e.each(t,function(e,t){o.setMarker(t,s)}),s.centerBounds&&o.setCenter(),void 0!==s.cluster&&!0===s.cluster&&o.addMarkersClusters(s),void 0!==s.onComplete&&s.onComplete.call({GmapsTool:o,markers:o.getMarkers(),bounds:o.bounds})),o},prepareMarkersOptions:function(e){return void 0===e?(this.setLog("error","Missing markers parameter"),!1):"undefined"!=typeof RichMarker||(this.setLog("error",'Missing "RichMarker" dependency'),!1)},getMarkers:function(){return this.markers},addMarkersClusters:function(t){var s=this;if("undefined"==typeof MarkerClusterer)return s.setLog("error",'Missing "MarkerClusterer" dependency'),!1;var o={maxZoom:s.gmapOptions.maxZoom-1};!1!==s.settings.clusterOptions.svg&&Object.keys(s.settings.clusterOptions.svg).length&&Object.keys(s.settings.clusterOptions.svg.sizes).length&&(o.styles=[],e.each(s.settings.clusterOptions.svg.sizes,function(e,t){var n=s.settings.clusterOptions.svg.colors.length?s.settings.clusterOptions.svg.colors[e]:s.settings.clusterOptions.svg.color,r='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="25" stroke="'+s.settings.clusterOptions.svg.borderColor+'" stroke-width="'+s.settings.clusterOptions.svg.borderWidth+'" fill="'+n+'" /></svg>';o.styles.push({textColor:s.settings.clusterOptions.svg.textColor,url:"data:image/svg+xml;base64,"+window.btoa(r),width:t,height:t})})),e.extend(!0,s.settings.clusterOptions,o,t.clusterOptions);var n=[];return e.each(s.getMarkers(),function(e,t){n.push(t.richMarker)}),new MarkerClusterer(s.gmap,n,s.settings.clusterOptions)},setMarker:function(t,s){var o=this;t.position=o.getLatLng(t.position),e.extend(t.richMarkerOptions={},o.settings.richMarkerOptions,{map:o.gmap,content:"object"==typeof t.content?t.content[0]:t.content,position:t.position},t.options),t.richMarker=new RichMarker(t.richMarkerOptions);var n=["click","dblclick","mouseover","mouseout"];return e.each(n,function(e,n){var r=o.formatEventName(n);void 0!==s[r]&&google.maps.event.addListener(t.richMarker,n,function(){s[r].call({GmapsTool:o,marker:t,event:this})})}),o.bounds.extend(t.position),o.markers.push(t),void 0!==s.onAdd&&s.onAdd.call({GmapsTool:o,marker:t}),t},setCenter:function(){return void 0!==this.bounds?(this.getMarkers().length>1&&this.gmap.fitBounds(this.bounds),this.gmap.setCenter(this.bounds.getCenter())):this.gmap.setCenter(this.gmapOptions.center),this},setLayers:function(t,s){var o=this;return o.layers=[],void 0===s&&(s={}),void 0!==t&&t.length>0&&e.each(t,function(e,t){o.prepareLayerOptions(t)&&o.setLayer(t,s)}),void 0!==s.onComplete&&s.onComplete.call({GmapsTool:o,layers:o.getLayers()}),o},getLayers:function(){return this.layers},prepareLayerOptions:function(e){return void 0===e.path||"http"===e.path.substring(0,4)||(this.setLog("error","The "+e.type+" file must be online"),!1)},setLayer:function(t,s){var o=this;e.extend(s,{url:t.path,preserveViewport:!0,map:o.gmap}),t.layer=new google.maps.KmlLayer(s);var n=["click","defaultviewport_changed","status_changed"];return e.each(n,function(e,n){var r=o.formatEventName(n);void 0!==s[r]&&t.layer.addListener(n,function(){s[r].call({GmapsTool:o,layer:t,event:this})})}),o.layers.push(t),void 0!==s.onAdd&&s.onAdd.call({GmapsTool:o,layer:t}),t},setStyles:function(t){var s=this;return e.getJSON(t).fail(function(){s.setLog("error","Json file not found")}).done(function(e){s.gmap.set("styles",e)}),s},setControls:function(t){var s=this;void 0===t&&(t={});var o={};if(e.extend(o,{mapTypeControl:!1,streetViewControl:!1,zoomControl:!1},t.mapOptions),this.setMapOptions(o),void 0!==t.zoom){var n=["in","out"];e.each(n,function(e,o){void 0!==t.zoom[o]&&t.zoom[o].length&&google.maps.event.addDomListener(t.zoom[o][0],"click",function(e){var n=s.gmap.getZoom();s.gmap.setZoom("in"===o?++n:--n),void 0!==t.zoom.onClick&&t.zoom.onClick.call({GmapsTool:s,zoom:{type:o,level:n},event:e})})})}return s},setLog:function(e,t){console[e]("GmapsTool: "+t)},getLatLng:function(e){return"string"==typeof e&&-1!==e.indexOf(",")&&(e=e.split(",")),"object"==typeof e&&2===e.length&&new google.maps.LatLng(e[0],e[1])},formatEventName:function(e){return"on"+e.substr(0,1).toUpperCase()+e.substr(1)}},e.fn.gmapsTool=function(t,s){return new e.GmapsTool(e(this),t,s)}}(jQuery);